#!/bin/bash

set -eEo pipefail

if [ -z "$ARCHYPE_PATH" ]; then
  # Try to get it from the source of this file
  ARCHYPE_PATH="$(readlink "$(which "${BASH_SOURCE[0]}")" | xargs dirname | xargs dirname)"
  if [ -z "$ARCHYPE_PATH" ]; then
    echo -e "Error: 'ARCHYPE_PATH' is not defined."
    exit 1
  fi
fi

LIB_DIR="${ARCHYPE_PATH}/lib"
UNITS_DIR="${ARCHYPE_PATH}/units"
INSTALL_STATE_DIR="$HOME/.local/state/archype/install"
ARCHYPE_CONFIG="$HOME/.config/archype"
ARCHYPE_THEMES="${ARCHYPE_CONFIG}/themes"
PRISTINE_CONFIG="${ARCHYPE_CONFIG}/pristine"
USER_BIN="$HOME/.local/bin"

mkdir -p ${INSTALL_STATE_DIR}
mkdir -p ${ARCHYPE_CONFIG}
mkdir -p ${ARCHYPE_THEMES}
mkdir -p ${USER_BIN}

# FLAGS
NO_PKG=""

source $LIB_DIR/print.sh

debug_info() {
  echo "LIB_DIR=${LIB_DIR}"
  echo "UNITS_DIR=${UNITS_DIR}"
  echo "INSTALL_STATE_DIR=${INSTALL_STATE_DIR}"
  echo "ARCHYPE_CONFIG=${ARCHYPE_CONFIG}"
  echo "ARCHYPE_THEMES=${ARCHYPE_THEMES}"
  echo "PRISTINE_CONFIG=${PRISTINE_CONFIG}"
  echo "USER_BIN=${USER_BIN}"
}

install_packages() {
  local PKG_FILE="$1"
  local PKG_MANAGER="$2"

  if [ -f "$PKG_FILE" ]; then
    print_title "-> Installing packages from $PKG_FILE..."
    local packages=()
    while IFS= read -r package; do
      # Trim comments, leading/trailing whitespace from the package name.
      package=$(echo -e "$package" | xargs | awk '!/^\s*#/ {print $1; exit}')
      if [ -n "$package" ]; then
        packages+=("$package")
      fi
    done < "$PKG_FILE"

    # Install all packages in a single command if any were found
    if [ ${#packages[@]} -gt 0 ]; then
      print_title "  -> Installing ${#packages[@]} packages: ${packages[*]}"
      if [ "$PKG_MANAGER" == "pacman" ]; then
        sudo pacman -Sy
        sudo pacman -S --noconfirm --needed "${packages[@]}"
      elif [ "$PKG_MANAGER" == "aur" ]; then
        yay -S --noconfirm "${packages[@]}"
      fi
    else
      print_title "  -> No packages to install"
    fi
  fi
}

install_unit() {
  local UNIT="$1"
  local UNIT_PATH="$UNITS_DIR/$UNIT"
  local UNIT_DEFAULT_CONFIG="$ARCHYPE_CONFIG/$UNIT"
  local UNIT_PRISTINE_CONFIG="${PRISTINE_CONFIG}/${UNIT}"
  local UNIT_PRISTINE_CONFIG_NEW="${PRISTINE_CONFIG}/${UNIT}_new"
  if [ ! -d "$UNIT_PATH" ]; then
    print_error "Error: Unit cannot be found in directory '$UNIT_PATH'"
    exit 1
  fi
  print_active "Unit: $UNIT"

  if [[ ! "$NO_PKG" ]]; then
    # Package Installation
    install_packages "$UNIT_PATH/packages.pacman" "pacman"
    install_packages "$UNIT_PATH/packages.aur" "aur"
  fi

  # Link binary files
  if [[ -d "$UNIT_PATH/bin" ]]; then
    print_title "-> Linking binary files from $UNIT_PATH/bin"
    while IFS= read -r file; do
      print_title "  -> $file -> $USER_BIN/"
      ln -sf "$file" "$USER_BIN/"
    done < <(find "$UNIT_PATH/bin" -maxdepth 1 -type f -executable)
  fi

  # Link config directory
  if [[ -d "$UNIT_PATH/default" ]]; then
    print_title "-> Linking config directory"
    if [ -L "$UNIT_DEFAULT_CONFIG" ]; then
      print_title "  -> Found $UNIT_DEFAULT_CONFIG, removing it!"
      rm -r "$UNIT_DEFAULT_CONFIG"
    fi
    print_title "  -> $UNIT_PATH/default -> $UNIT_DEFAULT_CONFIG"
    ln -sn "$UNIT_PATH/default" "$UNIT_DEFAULT_CONFIG"
  fi

  if [[ -f "$UNIT_PATH/unit.json" ]]; then
    print_title "-> Checking user configs"
    jq -c '.config[]?' "$UNIT_PATH/unit.json" | while read -r pair; do
      src=$(echo "$pair" | jq -r '.[0]')
      dst=$(echo "$pair" | jq -r '.[1]')
      flg=$(echo "$pair" | jq -r '.[2]')
      if [[ "$flg" == "null" ]]; then
        flg=""
      fi

      skip_existing=""
      if [[ "$flg" == *"s"* ]]; then
        skip_existing=1
      fi

      src_abs="$UNIT_PATH/config/$src"
      dst_abs="$HOME/$dst"
      pristine_abs="$UNIT_PRISTINE_CONFIG/$src"
      pristine_abs_new="$UNIT_PRISTINE_CONFIG_NEW/$src"

      # --Logic--
      # !src
      #   fail
      # src exists
      #   !dst
      #     override dst
      #     override pristine
      #   dst exists
      #     skip flag
      #       skip
      #     pristine exists
      #       pristine == dst
      #         override dst
      #         override pristine
      #     !pristine or pristine != dst
      #       copy with backup
      #       override pristine

      if [[ ! -f "$src_abs" ]]; then
        print_error "Config file cannot be found in the Archype source!"
        return 1
      fi

      mkdir -p $(dirname ${dst_abs})
      mkdir -p $(dirname ${pristine_abs_new})
      cp -f "$src_abs" "$pristine_abs_new"

      if [[ ! -f "$dst_abs" ]]; then
        print_title "  -> [override (DST not exists)] $src_abs -> $dst_abs"
        cp -f "$src_abs" "$dst_abs"
        continue
      fi

      if [[ "$skip_existing" ]]; then
        print_title "  -> [skip] $src_abs -> $dst_abs"
        continue
      fi

      if cmp -s "$pristine_abs" "$dst_abs"; then
        print_title "  -> [override (no change)] $src_abs -> $dst_abs"
        cp -f "$src_abs" "$dst_abs"
        continue
      fi

      print_title "  -> [$flg] $src_abs -> $dst_abs"
      archype-config-update "$src_abs" "$dst_abs"
    done
    rm -rf ${UNIT_PRISTINE_CONFIG}
    mv ${UNIT_PRISTINE_CONFIG_NEW} ${UNIT_PRISTINE_CONFIG}
  fi

  if [[ -f "$UNIT_PATH/unit.json" ]]; then
    print_title "-> Checking system configs"
    jq -c '.system[]?' "$UNIT_PATH/unit.json" | while read -r pair; do
      src=$(echo "$pair" | jq -r '.[0]')
      dst=$(echo "$pair" | jq -r '.[1]')

      src_abs="$UNIT_PATH/system/$src"
      dst_abs="$dst"
      if [[ ! -f "$src_abs" ]]; then
        print_error "Config file cannot be found in the Archype source!"
        return 1
      fi
      print_title "  -> $src_abs -> $dst_abs"
      # trick for sudo to find binary file with full path
      sudo $(which archype-config-update) "$src_abs" "$dst_abs"
    done
  fi

  if [[ -f "$UNIT_PATH/hypr.conf" ]]; then
    print_title "-> Updating hypr.conf"
    archype-unit-hypr-update "$UNIT" "$UNIT_PATH/hypr.conf"
  fi

  # Install themes by linking each one of them
  if [[ -d "$UNIT_PATH/themes" ]]; then
    print_title "-> Linking themes"
    while IFS= read -r theme; do
      print_title "  -> $theme -> $ARCHYPE_THEMES"
      ln -sfn "$theme" "$ARCHYPE_THEMES"
    done < <(find "$UNIT_PATH/themes" -maxdepth 1 -mindepth 1 -type d)
  fi

  # Run unit scripts
  if [[ -f "$UNIT_PATH/run.sh" ]]; then
    print_title "-> Executing $UNIT_PATH/run.sh"
    source $UNIT_PATH/run.sh
  fi

  print_success "\n$UNIT installed successfully."
  touch "$INSTALL_STATE_DIR/$UNIT.done"
}

if [ -z "$1" ]; then
  print_error "Error: Unit name should be provided."
  exit 1
fi

if [[ "$2" == "--no-pkg" ]]; then
  NO_PKG="1"
fi

install_unit "$1"
