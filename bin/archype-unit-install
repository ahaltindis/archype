#!/bin/bash

set -eE

if [ -z "$ARCHYPE_PATH" ]; then
  echo -e "Error: 'ARCHYPE_PATH' is not defined."
  exit 1
fi

LIB_DIR="${ARCHYPE_PATH}/lib"
UNITS_DIR="${ARCHYPE_PATH}/units"
INSTALL_STATE_DIR="$HOME/.local/state/archype/install"
USER_BIN_DIR="$HOME/.local/bin"

source $LIB_DIR/print.sh

install_packages() {
  local PKG_FILE="$1"
  local PKG_MANAGER="$2"

  if [ -f "$PKG_FILE" ]; then
    print_title "-> Installing packages from $PKG_FILE..."
    # Read the file line by line and install each package.
    while IFS= read -r package; do
      # Trim leading/trailing whitespace from the package name.
      package=$(echo "$package" | xargs)
      if [ -n "$package" ]; then
        print_title "  -> Installing: $package"
        if [ "$PKG_MANAGER" == "pacman" ]; then
          sudo pacman -S --noconfirm "$package" || print_active "Warning: Failed to install $package."
        elif [ "$PKG_MANAGER" == "aur" ]; then
          yay -S --noconfirm "$package" || print_active "Warning: Failed to install $package."
        fi
      fi
    done < "$PKG_FILE"
  fi
}

install_unit() {
  local UNIT="$1"
  local UNIT_PATH="$UNITS_DIR/$UNIT"
  if [ ! -d "$UNIT_PATH" ]; then
    print_error "Error: Unit directory '$UNIT_PATH' not found."
    exit 1
  fi
  print_active "Unit: $UNIT"

  # Package Installation
  install_packages "$UNIT_PATH/packages.pacman" "pacman"
  install_packages "$UNIT_PATH/packages.aur" "aur"

  # Link binary files
  if [[ -d "$UNIT_PATH/bin" ]]; then
    print_title "-> Linking binary files from $UNIT_PATH/bin"
    while IFS= read -r file; do
      print_title "  -> $file -> $USER_BIN_DIR/"
      ln -sf "$file" "$USER_BIN_DIR/"
    done < <(find "$UNIT_PATH/bin" -maxdepth 1 -type f -executable)
  fi

  # Run unit scripts
  if [[ -f "$UNIT_PATH/run.sh" ]]; then
    print_title "-> Executing $UNIT_PATH/run.sh"
    source $UNIT_PATH/run.sh
  fi

  print_success "\n$UNIT installed successfully."
  touch "$INSTALL_STATE_DIR/$UNIT.done"
}

install_unit "$1"
